# Сервис для расчета Excel-подобной таблицы
## Описание
Предназначен для расчета значений Excel-подобной таблицы. 
Содержимое таблицы принимается сервисом в следующем формате:
```json
[
	{
	"name": "A1",
	"value": "7"
	},
	{
	"name": "B1",
	"value": "A1-1"
	},
	{
	"name": "A2",
	"value": "A1+B1"
	},
	{
	"name": "B2",
	"value": "A2-1"
	}
]
```
где:
* `name` - имя ячейки;
* `value` - ее значение.

В теле ответа:
```json
[
  {
    "name": "A1",
    "result": {
      "status": "DONE",
      "value": "7"
    }
  },
  {
    "name": "B2",
    "result": {
      "status": "DONE",
      "value": "12"
    }
  },
  {
    "name": "A2",
    "result": {
      "status": "DONE",
      "value": "13"
    }
  },
  {
    "name": "B1",
    "result": {
      "status": "DONE",
      "value": "6"
    }
  }
]
```
где:
* `name` - имя ячейки;
* `result` - результат расчета выражения в ячейке:
    * `status` - статус операции (может быть `DONE` или `ERROR`);
    * `value` - непосредственно результат расчета (число или текст ошибки);

В случае, если значение ячейки удалось рассчитать, ее `status` будет `DONE`, 
а в `value` будет содержаться число.

Если при рассчете значения ячейки возникла ошибка, ее `status` будет `ERROR`, 
в элементе `value` будет содержаться описание ошибки. Например:
```json
{
    "name": "B1",
    "result": {
      "status": "ERROR",
      "value": "Неопознанный унарный оператор: *"
    }
}
```

## Реализация
Сервис реализован в виде сервлета, обрабатывающего входящие POST-запросы.
JSON-тело запроса парсится (используется Jackson), далее осуществляется расчет таблицы по следующему алгоритму:

1. Содержимое ячейки (строка) разбивается на токены (массив строк, элементы которого - числа/ссылки и операции/скобки). Если ячейка пуста (или содержит лишь пробелы), ее содержимое трактуется как "0".
1. Осуществляется предварительная обработка ячейки - удаляются пробелы, буквы, если они есть, конвертируются в заглавные.
1. Далее строка конвертируется в форму [обратной польской записи](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D0%B0%D1%8F_%D0%BF%D0%BE%D0%BB%D1%8C%D1%81%D0%BA%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C). Для реализации этой конвертации используется [алгоритм сортировочной станции](https://ru.wikipedia.org/wiki/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC_%D1%81%D0%BE%D1%80%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%BE%D1%87%D0%BD%D0%BE%D0%B9_%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B8). Для каждой ячейки создается ОПЗ-версия выражения, которое она содержит.
1. Далее производится обработка ссылочных значений - запрашивается значение ячейки по ссылке:
    * Если рассчет запрашиваемой ячейки был завершен, ссылка в исходном выражении заменяется на число. Если после этого в выражении еще остались ссылки, переходим к обработке следующей ссылки. Если ссылок больше не осталось - ячейка помечается как готовая к расчету.
    * Если расчет ячейки еще не завершен - пока пропускаем эту ячейку.
    * Если такой ячейки не существует, или ячейка ссылается сама на себя - выдается ошибка.
1. Когда ячейка помечена как готовая к расчету, осуществляется расчет ее значения на основании полученной ОПЗ-версии выражения.

Возможна ситуация, когда 2 и более ячеек ссылаются друг на друга, что делает расчет результата невозможным. Обработка данной ошибки реализована следующий образом - если расчет результата не удается завершить за установленное число итераций (по умолчанию - 50), ячейки, которые не удалось рассчитать, помечаются соответствующей ошибой.

После того, как расчет завершен, результаты преобразуются в JSON и отсылаются в теле ответа.

## Развертывание
1. Выполнить `maven clean package`;
1. Получившийся `war`-архив задеплоить на сервер, поддерживающий сервлеты (тестировалось с Jetty)

Сервис будет доступен по адресу `http://<hostname>/<deployment-name>/compute` 
